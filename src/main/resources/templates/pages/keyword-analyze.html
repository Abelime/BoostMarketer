<!--
=========================================================
* Soft UI Dashboard - v1.0.7
=========================================================

* Product Page: https://www.creative-tim.com/product/soft-ui-dashboard
* Copyright 2023 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <title>
    BoostMarketer - 마케팅을 위한 플랫폼
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="/assets/css/soft-ui-dashboard.css?v=1.0.7" rel="stylesheet" />
  <link href="/css/table.css" rel="stylesheet" />
  <link href="/css/common.css" rel="stylesheet" />
  <!-- Nepcha Analytics (nepcha.com) -->
  <!-- Nepcha is a easy-to-use web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. -->
  <script defer data-site="YOUR_DOMAIN_HERE" src="https://api.nepcha.com/js/nepcha-analytics.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
</head>
<style>
  .flex-container {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chart-container {
    height: 350px; /* 컨테이너 높이 설정 */
    width: 100%;  /* 컨테이너 너비 설정 */
    position: relative;
  }

  .chart-canvas {
    height: 100%; /* 캔버스가 컨테이너에 맞도록 설정 */
    width: 100%;
    position: absolute;
  }

  .month-inputs {
    display: none;
  }

  /*검색 input 박스*/
  .search-input {
    position: relative;
  }

  .search-input .form-control {
    padding-right: 40px;
  }

  .search-input .search-icon {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    color: #aaa;
  }

  .table {
    table-layout: fixed;
  }

  .table th,
  .table td {
    white-space: normal;  /* allows text to wrap */
    word-wrap: break-word; /* ensures text breaks within words if needed */
  }

</style>

<body class="g-sidenav-show  bg-gray-100">
<div th:replace="~{common/aside}"></div>
<main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
  <div th:replace="~{common/navbar}"></div>
  <div class="container-fluid">
    <div class="row">
      <div class="flex-container">
        <div class="col-6">
          <form>
            <div class="search-input">
              <input type="text" id="keyword" class="form-control" placeholder="검색어 키워드 입력" th:value="${keyword}">
              <i class="fas fa-search search-icon"></i>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">검색량 통계</h6>
          </div>
          <div class="card-body pt-4 p-3">
            <div class="row">
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">PC 검색량(월)</h6>
                  <span class="text-dark font-weight-bold" th:text="${keywordDto.monthSearchPc == 0 ? '0' : #numbers.formatInteger(keywordDto.monthSearchPc, 1, 'COMMA')}"></span>
                </div>
              </div>
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">Mobile 검색량(월)</h6>
                  <span class="text-dark font-weight-bold" th:text="${keywordDto.monthSearchMobile== 0 ? '0' : #numbers.formatInteger(keywordDto.monthSearchMobile, 1, 'COMMA')}"></span>
                </div>
              </div>
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">총 검색량(월)</h6>
                  <span class="text-dark font-weight-bold" th:text="${keywordDto.totalSearch == 0 ? '0' : #numbers.formatInteger(keywordDto.totalSearch, 1, 'COMMA')}"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">블로그 통계</h6>
          </div>
          <div class="card-body pt-4 p-3">
            <div class="row">
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">블로그 발행량(총)</h6>
                  <span class="text-dark font-weight-bold" th:text="${totalBlogCnt == 0 ? '0' : #numbers.formatInteger(totalBlogCnt, 1, 'COMMA')}"></span>
                </div>
              </div>
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">블로그 발행량(월)</h6>
                  <span class="text-dark font-weight-bold"></span>
                </div>
              </div>
              <div class="col-md-4 mb-2">
                <div class="border-0 p-4 bg-light rounded">
                  <h6 class="mb-3 text-sm">경쟁률</h6>
                  <span class="text-dark font-weight-bold"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">검색 트렌드</h6>
              <div class="d-flex align-items-center">
                <div class="dropdown me-2">
                  <button class="btn dropdown-toggle text-dark text-sm" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"></button>
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="#" data-value="일간">일간</a></li>
                    <li><a class="dropdown-item" href="#" data-value="월간">월간</a></li>
                  </ul>
                </div>
                <button class="btn text-dark px-3" data-bs-toggle="modal" data-bs-target="#datePickerModal">
                  <i class="far fa-calendar-alt"></i>
                  <span id="dateRangeText" class="text-sm">날짜 선택</span>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body pt-4 p-3">
            <div id="chart-container" class="chart-container">
              <canvas id="line-chart" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <!-- PC 섹션 배치 순서 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">PC 섹션 배치 순서</h6>
              <a class="btn text-dark px-3 mb-0" target="_blank" th:href="@{https://search.naver.com/search.naver(where='nexearch', sm='top_hty', fbm='0', ie='utf8', query=${keyword})}">
                <i class="fas fa-desktop text-dark me-2" aria-hidden="true"></i>PC
              </a>
            </div>
          </div>
          <div class="card-body pt-4 p-3">
            <ol class="list-group list-group-numbered">
              <!-- Loop through the sectionList and display each item -->
              <li class="list-group-item" th:each="section : ${pcSectionList}">
                <!-- Display the section name and count -->
                <span class="text-sm font-weight-bold text-dark me-3" th:text="${section.section}"></span> <!-- Display the section name -->
                <span class="text-xs font-weight-bold"
                      th:if="${section.cnt != '0'}"
                      th:text="' (' + ${section.cnt} + '개의 콘텐츠 노출 중)'"></span>
              </li>
            </ol>
          </div>
        </div>
      </div>
      <!-- Mobile 섹션 배치 순서 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Mobile 섹션 배치 순서</h6>
              <a class="btn text-dark px-3 mb-0" target="_blank" th:href="@{https://m.search.naver.com/search.naver(sm='mtp_hty.top', where='m', query=${keyword})}">
                <i class="fas fa-mobile-alt me-2" aria-hidden="true"></i>Mobile
              </a>
            </div>
          </div>
          <div class="card-body pt-4 p-3">
            <ol class="list-group list-group-numbered">
              <!-- Loop through the sectionList and display each item -->
              <li class="list-group-item" th:each="section : ${mobileSectionList}">
                <!-- Display the section name and count -->
                <span class="text-sm font-weight-bold text-dark me-3" th:text="${section.section}"></span> <!-- Display the section name -->
                <span class="text-xs font-weight-bold"
                      th:if="${section.cnt != '0'}"
                      th:text="' (' + ${section.cnt} + '개의 콘텐츠 노출 중)'"></span>
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">통합검색 노출 컨텐츠</h6>
            </div>
          </div>
          <div class="card-body pt-4 p-3">
            <div class="table-responsive p-0">
              <table class="table align-items-center mb-0">
                <thead>
                <tr>
                  <th class=" text-uppercase text-secondary text-xs font-weight-bolder" style="width: 30%">[블로그명] OR [카페명]</th>
                  <th class=" text-uppercase text-secondary text-xs font-weight-bolder" style="width: 35%">게시글 제목</th>
                  <th class=" text-uppercase text-secondary text-xs font-weight-bolder" style="width: 10%">작성일자</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="blog : ${blogList}">
                  <td class="align-middle ">
                    <p class="text-xs font-weight-bold mb-0" th:text="${blog.blogName}"></p>
                  </td>
                  <td class="align-middle ">
                    <a target="_blank" th:href="${blog.glUrl}"><p class="text-xs font-weight-bold mb-0" th:text="${blog.glName}"></p></a>
                  </td>
                  <td class="align-middle ">
                    <p class="text-xs font-weight-bold mb-0" th:text="${blog.glTime}"></p>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">연관 키워드</h6>
            </div>
          </div>
          <div class="card-body pt-4 p-3">
            <div class="table-responsive p-0">
              <table class="table align-items-center mb-0">
                <thead>
                <tr>
                  <th rowspan="2" class="text-center text-uppercase text-secondary text-xs font-weight-bolder">키워드</th>
                  <th colspan="3" class="text-center text-uppercase text-secondary text-xs font-weight-bolder">월 검색량</th>
                </tr>
                <tr>
                  <th class="text-center text-uppercase text-secondary text-xs font-weight-bolder">PC</th>
                  <th class="text-center text-uppercase text-secondary text-xs font-weight-bolder">MOBILE</th>
                  <th class="text-center text-uppercase text-secondary text-xs font-weight-bolder">총 검색량</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="keyword : ${relatedkeywordList}">
                  <td class="align-middle text-center">
                    <p class="text-xs font-weight-bold mb-0" th:text="${keyword.keywordName}">></p>
                  </td>
                  <td class="align-middle text-center">
                    <p class="text-xs font-weight-bold mb-0" th:text="${keyword.monthSearchPc == 0 ? '0' : #numbers.formatInteger(keyword.monthSearchPc, 1, 'COMMA')}"></p>
                  </td>
                  <td class="align-middle text-center">
                    <p class="text-xs font-weight-bold mb-0" th:text="${keyword.monthSearchMobile == 0 ? '0' : #numbers.formatInteger(keyword.monthSearchMobile, 1, 'COMMA')}"></p>
                  </td>
                  <td class="align-middle text-center">
                    <p class="text-xs font-weight-bold mb-0" th:text="${keyword.totalSearch == 0 ? '0' : #numbers.formatInteger(keyword.totalSearch, 1, 'COMMA')}"></p>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
<!--    <div class="row mt-4">-->
<!--      -->
<!--    </div>-->
  </div>
  <div th:insert="~{common/mainfooter.html :: footer}"></div>
</main>

<!-- 날짜 선택 모달 -->
<div class="modal fade" id="datePickerModal" tabindex="-1" aria-labelledby="datePickerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="datePickerModalLabel">기간 설정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- 기간 선택 -->
        <div class="row">
          <div class="col-6">
            <label for="startDate" class="form-label">시작 날짜</label>
            <input type="date" id="startDate" class="form-control" />
          </div>
          <div class="col-6">
            <label for="endDate" class="form-label">마지막 날짜</label>
            <input type="date" id="endDate" class="form-control" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary">적용</button>
      </div>
    </div>
  </div>
</div>



<div class="loader-wrapper">
  <div class="loader"></div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
  $('#keyword').keypress(function (event) {
    if (event.which === 13) {
      event.preventDefault();

      const keywordName = $('#keyword').val().trim();

      if (keywordName === '') {
        return;
      }
      FunLoadingBarStart();
      window.location.href = '/keyword-analyze?keyword=' + keywordName;
    }
  });

  //드롭다운
  $(document).ready(function () {
    // 화면 로드 시 기본 드롭다운 버튼 텍스트 설정
    $('#dropdownMenuButton').text('일간');

    // 모든 드롭다운 항목 초기화
    $('.dropdown-item').removeClass('active');

    // "일간" 항목을 활성화
    $('.dropdown-item[data-value="일간"]').addClass('active');

    // 드롭다운 항목 클릭 시 버튼 텍스트 변경 및 선택 상태 표시
    $('.dropdown-item').click(function () {
      var selectedText = $(this).data('value'); // 선택한 항목의 텍스트
      $('#dropdownMenuButton').text(selectedText); // 버튼 텍스트 변경

      // 모든 항목의 선택 상태 초기화
      $('.dropdown-item').removeClass('active');

      // 클릭된 항목에 선택 상태 적용
      $(this).addClass('active');
    });
  });

  //날짜, 달력, 그래프
  $(document).ready(function () {
    // 초기값 설정
    setDateRange('일간');

    // 일간, 월간 선택 버튼 클릭 이벤트 핸들러
    $(".dropdown-item").click(function () {
      const mode = $(this).data("value");
      setDateRange(mode);

      let buildParams = () => {
        return {
          'keyword': $("#keyword").val(),
          'dateType_Sel': mode,
          'startDate': $("#startDate").val(),
          'endDate': $("#endDate").val()
        };
      };

      let params = buildParams();
      let queryString = createQueryString(params);

      fetchChartData(queryString)
              .then(dataList => {
                const yConfig = getYAxisConfig(dataList);
                drawChart(ctx, dataList, yConfig);
              });

    });

    // 날짜 범위 설정 함수
    function setDateRange(mode) {
      const today = new Date();
      const startDate = new Date();
      const endDate = new Date();

      if (mode === '월간') {
        startDate.setFullYear(today.getFullYear() - 1, today.getMonth(), 1); // 1년 전 같은 월의 1일
        endDate.setFullYear(today.getFullYear(), today.getMonth(), 0); // 저번 달의 마지막 날
      } else {
        startDate.setMonth(today.getMonth() - 1); //저번달
        endDate.setDate(today.getDate() - 1); // 어제 날짜
      }

      const threeYearsAgo = new Date(today.getFullYear() - 3, 0, 1); // 3년 전 1월 1일 기준

      let initialStartDate = formatDate(startDate, mode);
      let initialEndDate = formatDate(endDate, mode);

      const formattedThreeYearsAgo = formatDate(threeYearsAgo, '일간');

      $('#dateRangeText').text(`${formatMonthRange(initialStartDate, initialEndDate, mode)}`);

      if (mode === '월간') {
        initialStartDate = formatDate(startDate, '');
        initialEndDate = formatDate(endDate, '');
      }

      $('#startDate').val(initialStartDate);
      $('#endDate').val(initialEndDate);

      $("#startDate, #endDate").attr("min", formattedThreeYearsAgo);
      $("#startDate, #endDate").attr("max", initialEndDate);


      // "닫기" 버튼을 클릭하면 초기값으로 복원
      $("#datePickerModal .btn-secondary").click(function () {
        $("#startDate").val(initialStartDate);
        $("#endDate").val(initialEndDate);
      });

      // "적용" 버튼을 클릭하면 초기값을 업데이트
      $("#datePickerModal .btn-primary").click(function () {
        initialStartDate = $("#startDate").val();
        initialEndDate = $("#endDate").val();
        $('#dateRangeText').text(formatMonthRange(initialStartDate, initialEndDate, mode));
        $('#datePickerModal').modal('hide');
        let buildParams = () => {
          return {
            'keyword': $("#keyword").val(),
            'dateType_Sel': mode,
            'startDate': $("#startDate").val(),
            'endDate': $("#endDate").val()
          };
        };

        let params = buildParams();
        let queryString = createQueryString(params);

        fetchChartData(queryString)
                .then(dataList => {
                  const yConfig = getYAxisConfig(dataList);
                  drawChart(ctx, dataList, yConfig);
                });
      });

      // 시작 날짜 변경 시 마지막 날짜의 최소값을 업데이트
      $("#startDate").on("change", function () {
        var startDate = $(this).val();
        var endDateInput = $("#endDate");

        // 마지막 날짜가 시작 날짜보다 앞지 않도록 제한
        if (endDateInput.val() < startDate) {
          endDateInput.val(startDate);
        }
        endDateInput.attr("min", startDate); // 최소값 업데이트
      });

      // 마지막 날짜 변경 시 시작 날짜의 최대값을 업데이트
      $("#endDate").on("change", function () {
        var endDate = $(this).val();
        var startDateInput = $("#startDate");

        // 시작 날짜가 마지막 날짜보다 뒤지 않도록 제한
        if (startDateInput.val() > endDate) {
          startDateInput.val(endDate);
        }
        startDateInput.attr("max", endDate); // 최대값 업데이트
      });
    }

    function formatDate(date, mode) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');

      if (mode === '월간') {
        return `${year}-${month}`;
      } else {
        return `${year}-${month}-${day}`;
      }
    }

    function formatMonthRange(startDate, endDate, mode) {
      if (mode === '월간') {
        return `${startDate.split('-')[0]}-${startDate.split('-')[1]} - ${endDate.split('-')[0]}-${endDate.split('-')[1]}`;
      } else {
        return `${startDate} - ${endDate}`;
      }
    }

    let myChart; // 차트 참조 변수

    const ctx = document.getElementById('line-chart').getContext('2d');

    const buildParams = () => {
        return {
            'keyword': $("#keyword").val(),
            'dateType_Sel': '일간',
            'startDate': $("#startDate").val(),
            'endDate': $("#endDate").val()
        };
    };

    const createQueryString = (params) => {
        return Object.keys(params)
            .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
            .join('&');
    };

    const fetchChartData = async (queryString) => {
        try {
            const response = await fetch(`/trendsChart?${queryString}`);
            const dataList = await response.json();
            return dataList;
        } catch (error) {
            console.error('데이터 가져오는 중 오류가 발생했습니다:', error);
            throw error;
        }
    };

    const getYAxisConfig = (dataList) => {
        const minDataValue = Math.min(...dataList.map(data => data['ratio']));
        const maxDataValue = Math.max(...dataList.map(data => data['ratio']));

        const yRange = maxDataValue - minDataValue;
        const yMin = Math.floor(minDataValue / 10) * 10;
        const yMax = Math.ceil(maxDataValue / 10) * 10;
        const stepSize = Math.ceil((yRange + 10) / 7);

        return { yMin, yMax, stepSize };
    };

    const drawChart = (ctx, dataList, yConfig) => {
        if (myChart) { // 기존 차트가 있으면 삭제
            myChart.destroy();
        }

      myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: dataList.map(data => data['period']),
              datasets: [{
                  label: $("#keyword").val(),
                  data: dataList.map(data => data['ratio']),
                  borderColor: 'rgba(199, 135, 235, 1)', // 연보라색 라인
                  borderWidth: 3,
                  pointRadius: 0,
                  pointBackgroundColor: 'rgba(199, 135, 235, 1)',
                  spanGaps: true,
              }],
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false,
                  },
                  tooltip: {
                      intersect: false,
                      mode: 'index',
                      callbacks: {
                          label: (tooltipItem) => `${$("#keyword").val()}: ${Intl.NumberFormat().format(Math.round(tooltipItem.raw))}`, // 정수로 포맷팅
                      },
                  },
              },
              scales: {
                  x: {
                      grid: {
                          display: false,
                      },
                      ticks: {
                          maxRotation: 0,
                          maxTicksLimit: 7,
                      },
                  },
                  y: {
                      min: yConfig.yMin,
                      max: yConfig.yMax,
                      ticks: {
                          stepSize: yConfig.stepSize,
                          maxTicksLimit: 7,
                          callback: (value) => new Intl.NumberFormat().format(Math.round(value)), // 정수 및 쉼표 추가
                      },
                      grid: {
                          drawVerticalLine: false,
                          color: 'rgba(0, 0, 0, 0.1)',
                      },
                  },
              },
          },
      });

  };

    const params = buildParams();
    const queryString = createQueryString(params);

    fetchChartData(queryString)
        .then(dataList => {
            const yConfig = getYAxisConfig(dataList);
            drawChart(ctx, dataList, yConfig);
        });
  });



</script>
<!-- Github buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>
<!--   Core JS Files   -->
<script src="/assets/js/core/popper.min.js"></script>
<script src="/assets/js/core/bootstrap.min.js"></script>
<script src="/js/common.js"></script>
</body>

</html>