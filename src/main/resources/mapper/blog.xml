<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="camel.BoostMarketer.blog.mapper.BlogMapper">

    <insert id="insertBlogPost" parameterType="BlogPostDto">
        INSERT INTO blog_post (blog_id, post_no, post_title, post_date, hashtag)
            SELECT #{blogId}, #{postNo, jdbcType=INTEGER}, #{postTitle}, #{postDate}, #{hashtag}
            FROM DUAL
            WHERE NOT EXISTS (
                SELECT 1
                FROM blog_post
                WHERE blog_id = #{blogId} AND post_no = #{postNo, jdbcType=INTEGER}
            )
    </insert>

    <insert id="insertKeyword" parameterType="keywordDto" useGeneratedKeys="true" keyProperty="keywordId">
        INSERT INTO keyword_dict (keyword_name)
            SELECT #{keywordName}
            FROM DUAL
            WHERE NOT EXISTS (
                SELECT 1
                FROM keyword_dict
                WHERE keyword_name = #{keywordName}
            )
        <selectKey resultType="Long" keyProperty="keywordId" order="AFTER">
            SELECT keyword_id
            FROM keyword_dict
            WHERE keyword_name = #{keywordName}
        </selectKey>
    </insert>

<!---->
<!--    <insert id="insertKeywordRank" parameterType="java.util.List">-->
<!--        INSERT INTO keyword_rank (post_no, keyword_id, keyword_rank) VALUES-->
<!--        <foreach item="item" collection="list" separator=",">-->
<!--            (#{item.postNo, jdbcType=INTEGER}, #{item.keywordId}, #{item.keywordRank})-->
<!--        </foreach>-->
<!--        ON DUPLICATE KEY UPDATE keyword_rank = VALUES(keyword_rank), updated_at = VALUES(updated_at);-->
<!--    </insert>-->

    <insert id="insertKeywordRank" parameterType="keywordDto">
        INSERT INTO keyword_rank (post_no, keyword_id, keyword_rank)
        SELECT * FROM (
                          SELECT #{postNo, jdbcType=INTEGER}, #{keywordId}, #{keywordRank} AS keyword_rank
                      ) AS tmp
        WHERE NOT EXISTS (
            SELECT * FROM keyword_rank
            WHERE post_no = #{postNo} AND keyword_id = #{keywordId} AND rank_date = current_date()
        )
        LIMIT 1;
    </insert>

    <select id="selectPostList" resultType="BlogPostDto">
        select *
          from blog_post;
    </select>

    <select id="selectKeyWordRank" parameterType="java.util.List" resultType="keywordDto">
        select bp.post_no, kd.keyword_id, kd.keyword_name, kr.keyword_rank, kr.rank_date
          from keyword_rank kr, keyword_dict kd, blog_post bp
         where kr.keyword_id = kd.keyword_id
           and kr.post_no = bp.post_no
    </select>


</mapper>
